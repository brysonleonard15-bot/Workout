<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workout Builder + Log (Static)</title>
  <style>
    :root{
      --bg0:#0b1020;
      --bg1:#0f1730;
      --card: rgba(255,255,255,.06);
      --text:#e9eefc;
      --muted:#a9b3d1;
      --line: rgba(255,255,255,.12);
      --accent:#31f3b0;   /* mint */
      --accent2:#7aa7ff;  /* soft blue */
      --danger:#ff5b6e;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:
        radial-gradient(1000px 500px at 15% 0%, rgba(49,243,176,.12), transparent 50%),
        radial-gradient(900px 500px at 90% 10%, rgba(122,167,255,.12), transparent 55%),
        radial-gradient(800px 500px at 50% 100%, rgba(255,91,110,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      min-height:100vh;
    }
    header{
      padding:28px 18px 18px;
      max-width:1100px;
      margin:0 auto;
    }
    .brand{display:flex;align-items:center;gap:14px;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(49,243,176,.95), rgba(49,243,176,.1)),
        radial-gradient(20px 20px at 70% 70%, rgba(122,167,255,.95), rgba(122,167,255,.1)),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 35px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-40%;
      background:conic-gradient(from 180deg, rgba(49,243,176,.0), rgba(49,243,176,.5), rgba(122,167,255,.5), rgba(49,243,176,.0));
      animation: spin 8s linear infinite;
      filter: blur(12px);
      opacity:.55;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    h1{font-size:20px;margin:0;letter-spacing:.2px;}
    .sub{margin:3px 0 0;color:var(--muted);font-size:13px;line-height:1.35;}

    main{
      max-width:1100px;
      margin:0 auto;
      padding:0 18px 38px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
    }
    @media (max-width: 980px){ main{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,.14);
    }
    .card .hd .title{display:flex;flex-direction:column;gap:2px;}
    .card .hd .title b{font-size:14px;letter-spacing:.2px;}
    .card .hd .title span{color:var(--muted);font-size:12px;}
    .card .bd{padding:16px}

    .grid2{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 540px){ .grid2{grid-template-columns:1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px;}
    input, select, button, textarea{font: inherit;}
    input[type="date"], input[type="text"], select, textarea{
      width:100%;
      background: rgba(0,0,0,.24);
      color:var(--text);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 11px;
      border-radius: 14px;
      outline:none;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
    }
    textarea{min-height:84px; resize:vertical}
    input[type="date"]:focus, input[type="text"]:focus, select:focus, textarea:focus{
      border-color: rgba(49,243,176,.55);
      box-shadow: 0 0 0 4px rgba(49,243,176,.12);
    }

    .row{
      gap:10px;
      align-items:end;
      padding:10px;
      border-radius: 16px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      margin:10px 0 0;
      display:grid;
    }
    /* Primary rows: Exercise | Sets | Reps | Rest | Remove */
    .row.primary{grid-template-columns: 1.7fr .8fr .8fr .9fr .9fr auto;}
    /* Aux rows: Aux Group | Exercise | Sets | Reps | Rest | Remove */
    .row.aux{grid-template-columns: 1.25fr 1.45fr .8fr .8fr .9fr .9fr auto;}

    @media (max-width: 780px){
      .row.primary{grid-template-columns:1fr 1fr; align-items:stretch}
      .row.aux{grid-template-columns:1fr 1fr; align-items:stretch}
      .row .removeBtn{grid-column:1/-1}
    }

    .btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(1px)}
    .btnPrimary{
      border-color: rgba(49,243,176,.35);
      background: rgba(49,243,176,.12);
    }
    .btnPrimary:hover{background: rgba(49,243,176,.16)}
    .btnDanger{
      border-color: rgba(255,91,110,.35);
      background: rgba(255,91,110,.12);
    }
    .btnDanger:hover{background: rgba(255,91,110,.16)}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:99px;background:var(--accent)}
    .dot2{background:var(--accent2)}
    .divider{height:1px; background: var(--line); margin:14px 0;}
    .hint{font-size:12px;color: var(--muted);line-height:1.4;margin:10px 0 0;}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}

    /* Log list */
    .logList{display:flex; flex-direction:column; gap:10px}
    .logItem{
      padding:12px;
      border-radius:16px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
    }
    .logItem .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
    .logItem h3{margin:0;font-size:14px;letter-spacing:.2px;}
    .logItem .meta{margin-top:4px;color:var(--muted);font-size:12px;}
    .logItem ul{margin:10px 0 0;padding-left:18px;color:var(--text);font-size:12.5px;line-height:1.35;}
    .empty{
      padding:14px;
      border:1px dashed rgba(255,255,255,.20);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      color: var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.16);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      font-size:12.5px;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-2px)}
  
    body.perf main{grid-template-columns:1fr;}
    body.perf aside{display:none;}
    body.perf header{padding-bottom:8px;}
    body.perf .card{box-shadow:none;}
    body.perf input[type="date"], body.perf input[type="text"], body.perf input[type="number"], body.perf select, body.perf textarea{font-size:16px;}
    body.perf .btn{font-size:16px; padding:12px 14px;}


    /* Per-set details compact layout */
    .setDetailsGrid{grid-template-columns: 70px 1fr 1fr;}
    .setCell{}
    @media (max-width: 520px){
      .setDetailsGrid{grid-template-columns: 1fr 1fr;}
      .setHdr, .wtHdr, .repsHdr{display:none;}
      .setCell{grid-column: 1 / -1;}
    }

</style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Workout Builder + Log</h1>
        <div style="margin-top:6px; font-size:11px; opacity:0.6;">Build: 2026-02-24 01:19:08</div>
        <p class="sub">Static HTML (no server). Improved templates: ‚Äúintensity‚Äù changes effort + rest + rep ranges, not just more sets.</p>
      </div>
    </div>
  </header>

  <main>
    <!-- Builder -->
    <section class="card">
      <div class="hd">
        <div class="title">
          <b>Build today‚Äôs workout</b>
          <span>Pick a primary lift focus, add auxiliaries, then save.</span>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;"><span class="pill"><span class="dot"></span>Local-only storage</span><button type="button" class="btn" id="perfModeBtn">‚ö° Performance</button><button type="button" class="btn" id="profileBtn">üë§ Profile</button></div>
      </div>
      <div class="bd">
        
        <div class="logItem" id="dashboardCard">
          <div class="top">
            <div>
              <h3 style="margin:0;">Dashboard</h3>
              <div class="meta" id="dashMeta">This week ‚Ä¢ Personal stats</div>
            </div>
          </div>
          <ul id="dashList" style="margin-top:10px;"></ul>
        </div>
<div class="grid2">
          <div>
            <label for="workoutDate">Date</label>
            <input id="workoutDate" type="date" />
          </div>
          <div>
            <label for="intensity">Auto template</label>
            <select id="intensity">
              <option value="manual">Manual (no auto-fill)</option>
              <option value="light">Light ‚Äî 1 primary (2√ó10‚Äì12, 90s) + 2 aux (2√ó12‚Äì15, 60s)</option>
              <option value="moderate">Moderate ‚Äî 2 primary (3√ó6‚Äì10, 120‚Äì150s) + 3 aux (3√ó10‚Äì15, 60‚Äì90s)</option>
              <option value="intense">Intense ‚Äî 2 primary (3√ó5‚Äì8, 150‚Äì180s) + 4 aux (3√ó8‚Äì15, 90s)</option>
            </select>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
              <button type="button" class="btn" id="editTemplatesBtn">‚öôÔ∏è Edit templates</button>
              <button type="button" class="btn" id="resetTemplatesBtn">‚Ü©Ô∏é Reset templates</button>
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top:12px;">
          <div>
            <label for="userName">User</label>
            <input id="userName" type="text" placeholder="e.g., Bryson" />
          </div>
</div>

        <div class="divider"></div>

        <div class="grid2">
          <div>
            <label for="primaryGroup">Primary workout group</label>
            <select id="primaryGroup"></select>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
              <button type="button" class="btn" id="randomWorkoutBtn">üé≤ Random workout</button>
              <button type="button" class="btn" id="toggleFavsBtn">‚≠ê Favorites</button>
            </div>
          </div>
          <div>
            <label for="notes">Notes (optional)</label>
            <textarea id="notes" placeholder="Energy level, tempo, PRs, pain notes, etc."></textarea>
          </div>
        </div>

        <div class="kpi">
          <span class="pill"><span class="dot"></span><span id="primaryCountPill">Primary: 0</span></span>
          <span class="pill"><span class="dot2"></span><span id="auxCountPill">Aux: 0</span></span>
        </div>

        <h2 style="margin:14px 0 8px; font-size:14px;">Primary exercises</h2>
        <div id="primaryContainer"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button type="button" class="btn btnPrimary" id="addPrimaryBtn">+ Add primary exercise</button>
        </div>

        <div class="divider"></div>

        <h2 style="margin:0 0 8px; font-size:14px;">Auxiliary exercises</h2>
        <div class="hint">Aux = smaller muscle groups and finishers (biceps, triceps, calves, abs, forearms, rear delts, etc.).</div>
        <div id="auxContainer"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button type="button" class="btn" id="addAuxBtn">+ Add auxiliary exercise</button>
        </div>

        <div class="divider"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button type="button" class="btn btnPrimary" id="saveBtn">Save to log</button>
          <button type="button" class="btn" id="shareBtn">üîó Share workout</button>
          <button type="button" class="btn" id="resetBtn">Reset form</button>
        </div>
        <div class="hint">Your log is saved in <b>localStorage</b> on this device/browser. Use Export JSON in the Log panel to backup.</div>
      </div>
    </section>

    <!-- Log -->
    <aside class="card">
      <div class="hd">
        <div class="title">
          <b>Your saved log</b>
          <span>Review, load, delete, or export your workouts.</span>
        </div>
        <span class="pill"><span class="dot2"></span>Offline</span>
      </div>
      <div class="bd">
        
        <div class="grid2" style="margin-bottom:12px;">
          <div>
            <label for="logUserFilter">Filter by user</label>
            <select id="logUserFilter">
              <option value="__all__">All users</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button type="button" class="btn" id="clearUserFilterBtn">Show all</button>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
          <button type="button" class="btn" id="exportBtn">Export JSON</button>
          <button type="button" class="btn btnDanger" id="clearBtn">Clear all</button>
        </div>
        <div id="exportBox" style="display:none;">
          <label for="exportText">Exported log JSON (copy/paste to backup)</label>
          <textarea id="exportText" spellcheck="false"></textarea>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button type="button" class="btn" id="hideExportBtn">Hide</button>
            <button type="button" class="btn btnPrimary" id="copyExportBtn">Copy</button>
          </div>
          <div class="divider"></div>
        </div>

        <div id="logList" class="logList"></div>
      </div>
    </aside>
  
  <!-- Templates Editor Modal -->
  <div id="templatesModal" style="display:none; position:fixed; inset:0; z-index:100; background: rgba(0,0,0,.55);">
    <div style="max-width:980px; margin:22px auto; padding:0 18px;">
      <div class="card" style="box-shadow: 0 30px 90px rgba(0,0,0,.65);">
        <div class="hd">
          <div class="title">
            <b>Template settings</b>
            <span>Customize Light / Moderate / Intense defaults (counts, sets, reps, rest). Saved locally.</span>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button type="button" class="btn" id="closeTemplatesBtn">Close</button>
            <button type="button" class="btn btnPrimary" id="saveTemplatesBtn">Save changes</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint" style="margin-top:0;">
            Tip: Keep ‚ÄúIntense‚Äù hard by effort + rest, not just endless sets. You can still tune volume here.
          </div>

          <div class="divider"></div>

          <div id="templatesEditor"></div>

          <div class="divider"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button type="button" class="btn" id="addTemplateNoteBtn">Add note to help users</button>
            <span class="pill"><span class="dot"></span>Stored in localStorage</span>
          </div>
          <div class="hint" id="templateNote" style="display:none; margin-top:10px;">
            Recommended starting point:
            Light = technique/recovery, Moderate = baseline hypertrophy, Intense = heavier/closer to failure with longer rests.
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Share Modal -->
  <div id="shareModal" style="display:none; position:fixed; inset:0; z-index:120; background: rgba(0,0,0,.55);">
    <div style="max-width:980px; margin:22px auto; padding:0 18px;">
      <div class="card" style="box-shadow: 0 30px 90px rgba(0,0,0,.65);">
        <div class="hd">
          <div class="title">
            <b>Share workout</b>
            <span>Copy a link that contains this workout. Recipient can open it and import to their log.</span>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button type="button" class="btn" id="closeShareBtn">Close</button>
            <button type="button" class="btn btnPrimary" id="copyShareBtn">Copy link</button>
          </div>
        </div>
        <div class="bd">
          <label for="shareLink">Share link</label>
          <textarea id="shareLink" spellcheck="false"></textarea>
          <div class="hint" style="margin-top:10px;">
            Note: The link stores workout data in the URL. Great for sharing a single session/template without any backend.
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Profile Modal -->
  <div id="profileModal" style="display:none; position:fixed; inset:0; z-index:130; background: rgba(0,0,0,.55);">
    <div style="max-width:980px; margin:22px auto; padding:0 18px;">
      <div class="card" style="box-shadow: 0 30px 90px rgba(0,0,0,.65);">
        <div class="hd">
          <div class="title">
            <b>User profile settings</b>
            <span>Per-user preferences (stored locally). Used for smarter defaults and random workouts.</span>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button type="button" class="btn" id="closeProfileBtn">Close</button>
            <button type="button" class="btn btnPrimary" id="saveProfileBtn">Save</button>
          </div>
        </div>
        <div class="bd">
          <div class="grid2">
            <div>
              <label for="profileGoal">Goal</label>
              <select id="profileGoal">
                <option>Hypertrophy</option>
                <option>Strength</option>
                <option>Endurance</option>
              </select>
            </div>
            <div>
              <label for="profileEquipment">Equipment</label>
              <select id="profileEquipment">
                <option>Full gym</option>
                <option>Home gym</option>
                <option>Dumbbells only</option>
                <option>Machines only</option>
              </select>
            </div>
          </div>
          <div class="grid2" style="margin-top:12px;">
            <div>
              <label for="profileRepLow">Preferred reps (low)</label>
              <input id="profileRepLow" type="number" min="1" max="30" step="1" />
            </div>
            <div>
              <label for="profileRepHigh">Preferred reps (high)</label>
              <input id="profileRepHigh" type="number" min="1" max="30" step="1" />
            </div>
          </div>
          <div class="hint" style="margin-top:10px;">
            These settings are optional. They help tailor random workouts and future recommendations.
          </div>
        </div>
      </div>
    </div>
  </div>

</main>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  const BUILD_VERSION = "2026-02-24 01:19:08";
  console.log("Workout Log Build:", BUILD_VERSION);
  // Safari-safe clone helper
  const sClone = (obj) => (typeof structuredClone === "function" ? sClone(obj) : JSON.parse(JSON.stringify(obj)));
  // ----------------------------
  // Data: groups + exercises
  // ----------------------------
  const primaryGroups = {
    "Chest": [
      "Barbell Bench Press",
      "Incline Barbell Bench Press",
      "Dumbbell Bench Press",
      "Incline Dumbbell Press",
      "Flat Dumbbell Press (Neutral Grip)",
      "Weighted Dips",
      "Machine Chest Press",
      "Smith Machine Bench Press",
      "Cable Fly (High-to-Low)",
      "Cable Fly (Low-to-High)",
      "Pec Deck / Machine Fly",
      "Dumbbell Fly (Flat/Incline)",
      "Push-Up (Weighted/Slow Tempo)"
    ],
    "Back": [
      "Weighted Pull-Up / Chin-Up",
      "Lat Pulldown (Wide/Neutral)",
      "Chest-Supported Row",
      "Seated Cable Row",
      "One-Arm Dumbbell Row",
      "Barbell Row",
      "T-Bar Row",
      "Machine Row (Plate-Loaded)",
      "Straight-Arm Pulldown",
      "Back Extension (Controlled)",
      "Deadlift (Technique/Strength)",
      "Rack Pull"
    ],
    "Legs": [
      "Back Squat",
      "Front Squat",
      "Leg Press",
      "Hack Squat",
      "Bulgarian Split Squat",
      "Walking Lunge",
      "Romanian Deadlift",
      "Good Morning (Light)",
      "Lying Leg Curl",
      "Seated Leg Curl",
      "Leg Extension",
      "Hip Thrust",
      "Glute Bridge",
      "Step-Up"
    ],
    "Shoulders": [
      "Overhead Press (Barbell)",
      "Seated Dumbbell Press",
      "Standing Dumbbell Press",
      "Machine Shoulder Press",
      "Arnold Press",
      "Lateral Raise (Dumbbell)",
      "Cable Lateral Raise",
      "Machine Lateral Raise",
      "Rear Delt Fly (Machine)",
      "Rear Delt Cable Fly",
      "Face Pull",
      "Upright Row (Cable/BB - light)"
    ],
    "Arms": [
      "Close-Grip Bench Press",
      "Dip (Triceps emphasis)",
      "Triceps Pressdown (Cable)",
      "Overhead Triceps Extension (Cable)",
      "Skull Crushers (EZ-Bar)",
      "EZ-Bar Curl",
      "Dumbbell Curl (Alternating)",
      "Incline Dumbbell Curl",
      "Hammer Curl",
      "Cable Curl",
      "Weighted Chin-Up (Biceps emphasis)",
      "Reverse Curl (EZ-Bar)"
    ]
  };

  const auxGroups = {
    "Biceps": [
      "Incline Dumbbell Curl",
      "Hammer Curl",
      "Preacher Curl (EZ-Bar)",
      "Cable Curl (Rope/Bar)",
      "Bayesian Cable Curl",
      "Concentration Curl",
      "Spider Curl",
      "EZ-Bar Reverse Curl"
    ],
    "Triceps": [
      "Overhead Cable Extension",
      "Rope Pressdown",
      "Single-Arm Pressdown",
      "Dumbbell Overhead Extension",
      "Skull Crushers (Light)",
      "Cable Kickback",
      "Close-Grip Push-Up"
    ],
    "Calves": [
      "Standing Calf Raise",
      "Seated Calf Raise",
      "Leg Press Calf Press",
      "Donkey Calf Raise",
      "Single-Leg Calf Raise",
      "Tibialis Raise"
    ],
    "Abs": [
      "Cable Crunch",
      "Hanging Knee Raise",
      "Hanging Leg Raise",
      "Ab Wheel Rollout",
      "Plank (Timed)",
      "Side Plank (Timed)",
      "Dead Bug (Controlled)",
      "Pallof Press"
    ],
    "Forearms": [
      "Wrist Curl",
      "Reverse Wrist Curl",
      "Farmer Carry (Timed)",
      "Plate Pinch Hold (Timed)",
      "Wrist Roller"
    ],
    "Rear Delts": [
      "Face Pull",
      "Reverse Pec Deck",
      "Rear Delt Cable Fly",
      "Bent-Over Rear Delt Raise",
      "Chest-Supported Rear Delt Raise"
    ],
    "Upper Back / Traps": [
      "Dumbbell Shrug",
      "Barbell Shrug",
      "Cable Y-Raise",
      "Prone Trap Raise",
      "Face Pull (High)"
    ],
    "Quads": [
      "Leg Extension",
      "Hack Squat (Light/Moderate)",
      "Leg Press (Quad bias)",
      "Front Squat (Light/Moderate)",
      "Sissy Squat (Assisted)",
      "Split Squat (Quad bias)",
      "Step-Up (Quad bias)"
    ],
    "Hamstrings": [
      "Seated Leg Curl",
      "Lying Leg Curl",
      "Romanian Deadlift (Light/Moderate)",
      "Good Morning (Light)",
      "Glute-Ham Raise",
      "Cable Pull-Through",
      "Single-Leg RDL"
    ]
  };

  const setOptions = ["1","2","3","4","5","6"];
  // Keep reps dropdown simple but cover the recommended ranges
  const repOptions = ["5","6","8","10","12","15","20"];
  
    // Weight (lbs)
    const wtWrap = document.createElement("div");
    const wtLab = document.createElement("label");
    wtLab.textContent = "Default Wt";
    const wtInp = document.createElement("input");
    wtInp.type = "number";
    wtInp.min = "0";
    wtInp.step = "2.5";
    wtInp.placeholder = "lbs";
    wtInp.className = "weightInp";
    wtWrap.appendChild(wtLab);
    wtWrap.appendChild(wtInp);

    // Per-set details (weights + reps per set)
    const detailsWrap = document.createElement("div");
    detailsWrap.className = "setDetailsWrap";
    detailsWrap.style.gridColumn = "1 / -1";
    detailsWrap.style.display = "none";
    detailsWrap.style.marginTop = "8px";
    detailsWrap.style.padding = "10px";
    detailsWrap.style.borderRadius = "14px";
    detailsWrap.style.background = "rgba(0,0,0,.18)";
    detailsWrap.style.border = "1px solid rgba(255,255,255,.10)";

    const detailsHdr = document.createElement("div");
    detailsHdr.style.display = "flex";
    detailsHdr.style.gap = "10px";
    detailsHdr.style.flexWrap = "wrap";
    detailsHdr.style.alignItems = "center";
    detailsHdr.style.justifyContent = "space-between";

    const detailsTitle = document.createElement("div");
    detailsTitle.style.color = "var(--muted)";
    detailsTitle.style.fontSize = "12px";
    detailsTitle.textContent = "Per-set tracking (weight + reps).";

    const detailsBtns = document.createElement("div");
    detailsBtns.style.display = "flex";
    detailsBtns.style.gap = "8px";
    detailsBtns.style.flexWrap = "wrap";

    const toggleDetailsBtn = document.createElement("button");
    toggleDetailsBtn.type = "button";
    toggleDetailsBtn.className = "btn";
    toggleDetailsBtn.textContent = "üìã Sets detail";

    const fillBtn = document.createElement("button");
    fillBtn.type = "button";
    fillBtn.className = "btn";
    fillBtn.textContent = "Fill from defaults";

    const copyDownBtn = document.createElement("button");
    copyDownBtn.type = "button";
    copyDownBtn.className = "btn";
    copyDownBtn.textContent = "Copy last ‚Üì";

    detailsBtns.appendChild(toggleDetailsBtn);
    detailsBtns.appendChild(fillBtn);
    detailsBtns.appendChild(copyDownBtn);

    detailsHdr.appendChild(detailsTitle);
    detailsHdr.appendChild(detailsBtns);

    const detailsGrid = document.createElement("div");
    detailsGrid.className = "setDetailsGrid";
    detailsGrid.style.display = "grid";
    detailsGrid.style.gridTemplateColumns = "1fr 1fr 1fr";
    detailsGrid.style.gap = "8px";
    detailsGrid.style.marginTop = "10px";

    // header row
    const h1 = document.createElement("div"); h1.className="setHdr"; h1.style.color="var(--muted)"; h1.style.fontSize="12px"; h1.textContent="Set";
    const h2 = document.createElement("div"); h2.className="wtHdr"; h2.style.color="var(--muted)"; h2.style.fontSize="12px"; h2.textContent="Weight (lb)";
    const h3 = document.createElement("div"); h3.className="repsHdr"; h3.style.color="var(--muted)"; h3.style.fontSize="12px"; h3.textContent="Reps";
    detailsGrid.appendChild(h1); detailsGrid.appendChild(h2); detailsGrid.appendChild(h3);

    detailsWrap.appendChild(detailsHdr);
    detailsWrap.appendChild(detailsGrid);

    function rebuildSetDetails(preserve=true){
      const targetSets = parseInt(setsSel.value || "0", 10) || 0;
      const existing = {};
      if (preserve){
        Array.from(detailsGrid.querySelectorAll("[data-set]")).forEach(inp => {
          const s = inp.getAttribute("data-set");
          const k = inp.getAttribute("data-kind");
          existing[`${s}_${k}`] = inp.value;
        });
      }
      // remove old rows (keep first 3 header cells)
      while (detailsGrid.children.length > 3) detailsGrid.removeChild(detailsGrid.lastChild);

      for (let i=1; i<=targetSets; i++){
        const cSet = document.createElement("div");
        cSet.className = "setCell";
        cSet.textContent = "Set " + String(i);
        cSet.style.padding = "10px 11px";
        cSet.style.border = "1px solid rgba(255,255,255,.12)";
        cSet.style.borderRadius = "14px";
        cSet.style.background = "rgba(0,0,0,.24)";
        cSet.style.color = "var(--text)";
        cSet.style.fontSize = "13px";

        const w = document.createElement("input");
        w.type = "number"; w.min="0"; w.step="2.5"; w.placeholder="lbs";
        w.className = "setWeightInp";
        w.setAttribute("data-set", String(i));
        w.setAttribute("data-kind", "w");
        w.style.width="100%";
        w.style.background="rgba(0,0,0,.24)";
        w.style.color="var(--text)";
        w.style.border="1px solid rgba(255,255,255,.12)";
        w.style.padding="10px 11px";
        w.style.borderRadius="14px";

        const r = document.createElement("input");
        r.type = "number"; r.min="0"; r.step="1"; r.placeholder="reps";
        r.className = "setRepsInp";
        r.setAttribute("data-set", String(i));
        r.setAttribute("data-kind", "r");
        r.style.width="100%";
        r.style.background="rgba(0,0,0,.24)";
        r.style.color="var(--text)";
        r.style.border="1px solid rgba(255,255,255,.12)";
        r.style.padding="10px 11px";
        r.style.borderRadius="14px";

        // restore if available
        const ew = existing[`${i}_w`];
        const er = existing[`${i}_r`];
        if (typeof ew !== "undefined") w.value = ew;
        if (typeof er !== "undefined") r.value = er;

        detailsGrid.appendChild(cSet);
        detailsGrid.appendChild(w);
        detailsGrid.appendChild(r);
      }
    }

    function fillFromDefaults(){
      const targetSets = parseInt(setsSel.value || "0", 10) || 0;
      const dw = (wtInp.value || "").trim();
      const dr = (repsSel.value || "").trim();
      if (!targetSets){ toast("Set sets first"); return; }
      rebuildSetDetails(true);
      Array.from(detailsGrid.querySelectorAll(".setWeightInp")).forEach(inp => { if (dw) inp.value = dw; });
      Array.from(detailsGrid.querySelectorAll(".setRepsInp")).forEach(inp => { if (dr) inp.value = dr; });
      toast("Filled");
    }

    function copyDownFromLast(){
      const targetSets = parseInt(setsSel.value || "0", 10) || 0;
      if (targetSets < 2){ toast("Need 2+ sets"); return; }

      for (let i=2; i<=targetSets; i++){
        const prevW = detailsGrid.querySelector(`.setWeightInp[data-set="${i-1}"]`);
        const prevR = detailsGrid.querySelector(`.setRepsInp[data-set="${i-1}"]`);
        const curW  = detailsGrid.querySelector(`.setWeightInp[data-set="${i}"]`);
        const curR  = detailsGrid.querySelector(`.setRepsInp[data-set="${i}"]`);
        if (!prevW || !prevR || !curW || !curR) continue;

        // Only copy into empty fields (so you don't overwrite)
        if (!curW.value && prevW.value) curW.value = prevW.value;
        if (!curR.value && prevR.value) curR.value = prevR.value;
      }
      toast("Copied down");
    }

    copyDownBtn.addEventListener("click", () => copyDownFromLast());


    toggleDetailsBtn.addEventListener("click", () => {
      const on = detailsWrap.style.display !== "none";
      detailsWrap.style.display = on ? "none" : "block";
      if (!on) rebuildSetDetails(true);
    });

    fillBtn.addEventListener("click", () => fillFromDefaults());

    setsSel.addEventListener("change", () => {
      if (detailsWrap.style.display !== "none") rebuildSetDetails(true);
    });

// Rest options in seconds
  const restOptions = ["45","60","90","120","150","180","240"];

  // Template defaults (the ‚Äúclean upgrade‚Äù)
  // Light:    primary 1x (2 sets, 12 reps, 90s) + aux 2x (2 sets, 15 reps, 60s)
  // Moderate: primary 2x (3 sets, 8 reps, 150s) + aux 3x (3 sets, 12 reps, 90s)
  // Intense:  primary 2x (3 sets, 6 reps, 180s) + aux 4x (3 sets, 10 reps, 90s)
  const DEFAULT_TEMPLATES = {
    // Light:    1 primary (2√ó12, 90s) + 2 aux (2√ó15, 60s)
    // Moderate: 2 primary (3√ó8, 150s) + 3 aux (3√ó12, 90s)
    // Intense:  2 primary (3√ó6, 180s) + 4 aux (3√ó10, 90s)
    light:    { pCount: 1, aCount: 2, pSets: 2, pReps: 12, pRest: 90,  aSets: 2, aReps: 15, aRest: 60 },
    moderate: { pCount: 2, aCount: 3, pSets: 3, pReps: 8,  pRest: 150, aSets: 3, aReps: 12, aRest: 90 },
    intense:  { pCount: 2, aCount: 4, pSets: 3, pReps: 6,  pRest: 180, aSets: 3, aReps: 10, aRest: 90 }
  };

  const TEMPLATES_KEY = "workout_templates_v1";

  function clampInt(v, min, max, fallback){
    const n = parseInt(String(v), 10);
    if (Number.isFinite(n)){
      return Math.max(min, Math.min(max, n));
    }
    return fallback;
  }

  function loadTemplates(){
    try{
      const raw = localStorage.getItem(TEMPLATES_KEY);
      const obj = JSON.parse(raw || "null");
      if (!obj || typeof obj !== "object") return sClone(DEFAULT_TEMPLATES);
      // Normalize
      const out = sClone(DEFAULT_TEMPLATES);
      for (const k of ["light","moderate","intense"]){
        if (!obj[k]) continue;
        out[k] = {
          pCount: clampInt(obj[k].pCount, 1, 6, out[k].pCount),
          aCount: clampInt(obj[k].aCount, 0, 8, out[k].aCount),
          pSets:  clampInt(obj[k].pSets, 1, 6, out[k].pSets),
          pReps:  clampInt(obj[k].pReps, 1, 30, out[k].pReps),
          pRest:  clampInt(obj[k].pRest, 15, 600, out[k].pRest),
          aSets:  clampInt(obj[k].aSets, 1, 6, out[k].aSets),
          aReps:  clampInt(obj[k].aReps, 1, 30, out[k].aReps),
          aRest:  clampInt(obj[k].aRest, 15, 600, out[k].aRest)
        };
      }
      return out;
    }catch(e){
      return sClone(DEFAULT_TEMPLATES);
    }
  }

  function saveTemplates(obj){
    localStorage.setItem(TEMPLATES_KEY, JSON.stringify(obj));
  }

  // Active templates (editable)
  let templates = loadTemplates();
// ----------------------------
  // DOM helpers
  // ----------------------------
  const $ = (id) => document.getElementById(id);

  const toast = (msg) => {
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1500);
  };

  const makeOption = (val, label) => {
    const o = document.createElement("option");
    o.value = val;
    o.textContent = label ?? val;
    return o;
  };

  const fillSelect = (select, options, placeholder) => {
    select.innerHTML = "";
    if (placeholder) select.appendChild(makeOption("", placeholder));
    options.forEach(v => select.appendChild(makeOption(v)));
  };

  // Searchable list helper (for <datalist>)
  const fillDataList = (datalistEl, options) => {
    datalistEl.innerHTML = "";
    options.forEach(v => datalistEl.appendChild(makeOption(v)));
  };

  // Favorites (per user)
  const FAVS_KEY = "workout_favs_v1";
  let showFavsOnly = false;

  function loadFavs(){
    try{
      const raw = localStorage.getItem(FAVS_KEY);
      const obj = JSON.parse(raw || "{}");
      return (obj && typeof obj === "object") ? obj : {};
    }catch(e){
      return {};
    }
  }

  function saveFavs(obj){
    localStorage.setItem(FAVS_KEY, JSON.stringify(obj));
  }

  function getActiveUser(){
    const u = ($("userName")?.value || "").trim() || "Default";
    return u;
  }

  function getUserFavs(user){
    const all = loadFavs();
    if (!all[user]) all[user] = { primary:{}, aux:{} };
    if (!all[user].primary) all[user].primary = {};
    if (!all[user].aux) all[user].aux = {};
    return all[user];
  }

  function isFavPrimary(user, group, exercise){
    const favs = getUserFavs(user);
    const arr = favs.primary[group] || [];
    return arr.includes(exercise);
  }

  function isFavAux(user, group, exercise){
    const favs = getUserFavs(user);
    const arr = favs.aux[group] || [];
    return arr.includes(exercise);
  }

  function toggleFavPrimary(user, group, exercise){
    const all = loadFavs();
    if (!all[user]) all[user] = { primary:{}, aux:{} };
    all[user].primary = all[user].primary || {};
    const arr = all[user].primary[group] ? all[user].primary[group].slice() : [];
    const idx = arr.indexOf(exercise);
    if (idx >= 0) arr.splice(idx,1); else arr.push(exercise);
    all[user].primary[group] = arr;
    saveFavs(all);
  }

  function toggleFavAux(user, group, exercise){
    const all = loadFavs();
    if (!all[user]) all[user] = { primary:{}, aux:{} };
    all[user].aux = all[user].aux || {};
    const arr = all[user].aux[group] ? all[user].aux[group].slice() : [];
    const idx = arr.indexOf(exercise);
    if (idx >= 0) arr.splice(idx,1); else arr.push(exercise);
    all[user].aux[group] = arr;
    saveFavs(all);
  }

  function sortWithFavs(list, favsArr){
    const favSet = new Set(favsArr || []);
    const favs = [];
    const rest = [];
    (list || []).forEach(x => (favSet.has(x) ? favs : rest).push(x));
    return showFavsOnly ? favs : favs.concat(rest);
  }


  // Stats / PRs / Settings
  const PR_KEY = "workout_prs_v1";
  const SETTINGS_KEY = "workout_user_settings_v1";
  const UI_KEY = "workout_ui_v1";

  function loadObj(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      const obj = JSON.parse(raw || "null");
      return (obj && typeof obj === "object") ? obj : fallback;
    }catch(e){ return fallback; }
  }
  function saveObj(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

  function getUserSettings(user){
    const all = loadObj(SETTINGS_KEY, {});
    if (!all[user]){
      all[user] = {
        goal: "Hypertrophy",
        equipment: "Full gym",
        prefRepLow: 6,
        prefRepHigh: 12
      };
      saveObj(SETTINGS_KEY, all);
    }
    return all[user];
  }

  function setUserSettings(user, settings){
    const all = loadObj(SETTINGS_KEY, {});
    all[user] = settings;
    saveObj(SETTINGS_KEY, all);
  }

  function calcE1RM(weight, reps){
    const w = parseFloat(weight || "0");
    const r = parseInt(reps || "0", 10);
    if (!w || !r) return 0;
    // Epley
    return w * (1 + r/30);
  }

  function updatePRsFromWorkout(item){
    const all = loadObj(PR_KEY, {});
    const user = (item.userName || "Default").trim() || "Default";
    if (!all[user]) all[user] = {};

    const updates = [];

    const check = (row) => {
      const ex = (row.exercise || "").trim();
      if (!ex) return;

      // Prefer per-set details if present
      const sets = Array.isArray(row.setDetails) && row.setDetails.length ? row.setDetails : null;

      const candidates = [];
      if (sets){
        sets.forEach(s => {
          const w = parseFloat(s.weight || "0");
          const r = parseInt(s.reps || "0", 10);
          if (w && r) candidates.push({ w, r });
        });
      } else {
        const w = parseFloat(row.weight || "0");
        const r = parseInt(row.reps || "0", 10);
        if (w && r) candidates.push({ w, r });
      }

      if (!candidates.length) return;

      // Choose best e1RM candidate for PR evaluation, but also track best top weight.
      let best = candidates[0];
      let bestE1 = calcE1RM(best.w, best.r);
      candidates.forEach(c => {
        const e = calcE1RM(c.w, c.r);
        if (e > bestE1){
          bestE1 = e;
          best = c;
        }
      });

      const w = best.w;
      const r = best.r;
      const e1 = bestE1;
      const cur = all[user][ex] || { bestE1RM: 0, bestWeight: 0, bestRepsAtBestWeight: 0 };

      let changed = false;

      if (e1 > (cur.bestE1RM || 0)){
        cur.bestE1RM = e1;
        changed = true;
      }

      // best top weight, with tie-breaker by reps
      if (w > (cur.bestWeight || 0)){
        cur.bestWeight = w;
        cur.bestRepsAtBestWeight = r;
        changed = true;
      } else if (w === (cur.bestWeight || 0) && r > (cur.bestRepsAtBestWeight || 0)){
        cur.bestRepsAtBestWeight = r;
        changed = true;
      }

      if (changed){
        all[user][ex] = cur;
        updates.push(ex);
      }
    };

    (item.primary || []).forEach(check);
    (item.aux || []).forEach(check);

    saveObj(PR_KEY, all);
    return updates;
  }


  const fmtRest = (sec) => {
    const s = Number(sec || 0);
    if (!s) return "";
    if (s < 60) return `${s}s`;
    if (s % 60 === 0) return `${s/60}m`;
    const m = Math.floor(s/60);
    const r = s % 60;
    return `${m}m ${r}s`;
  };

  // ----------------------------
  // Build group dropdowns
  // ----------------------------
  function initGroupSelects(){
    const pg = $("primaryGroup");
    pg.innerHTML = "";
    Object.keys(primaryGroups).forEach(g => pg.appendChild(makeOption(g)));
  }

  // ----------------------------
  // Row builders
  // ----------------------------
  function createExerciseRow({kind, groupValue, exerciseValue, setsValue, repsValue, restValue, weightValue}){
    const row = document.createElement("div");
    row.className = `row ${kind === "primary" ? "primary" : "aux"}`;
    row.dataset.kind = kind;

    let groupSel = null;

    // For aux, include group dropdown per row
    if (kind === "aux"){
      const groupWrap = document.createElement("div");
      const lab = document.createElement("label");
      lab.textContent = "Aux group";
      groupSel = document.createElement("select");
      groupSel.className = "auxGroupSel";

      groupWrap.appendChild(lab);
      groupWrap.appendChild(groupSel);

      row.appendChild(groupWrap);

      // Fill aux group options
      groupSel.innerHTML = "";
      Object.keys(auxGroups).forEach(g => groupSel.appendChild(makeOption(g)));
      if (groupValue && auxGroups[groupValue]) groupSel.value = groupValue;
    }

    // Exercise (searchable: input + datalist)
    const exWrap = document.createElement("div");
    const exLab = document.createElement("label");
    exLab.textContent = (kind === "primary") ? "Exercise" : "Aux exercise";

    const exInput = document.createElement("input");
    exInput.className = "exerciseInput";
    exInput.type = "text";
    exInput.placeholder = "Type to search‚Ä¶";

    // Unique datalist per row
    const dlId = `dl_${kind}_${Math.random().toString(16).slice(2)}_${Date.now()}`;
    const exList = document.createElement("datalist");
    exList.id = dlId;
    exInput.setAttribute("list", dlId);

    exWrap.appendChild(exLab);
    exWrap.appendChild(exInput);

    const favBtn = document.createElement("button");
    favBtn.type = "button";
    favBtn.className = "btn";
    favBtn.style.padding = "10px 12px";
    favBtn.style.borderRadius = "14px";
    favBtn.style.marginTop = "8px";
    favBtn.textContent = "‚òÜ Favorite";
    exWrap.appendChild(favBtn);

    exWrap.appendChild(exList);
// Sets
    const setsWrap = document.createElement("div");
    const setsLab = document.createElement("label");
    setsLab.textContent = "Sets";
    const setsSel = document.createElement("select");
    setsSel.className = "setsSel";
    fillSelect(setsSel, setOptions, "");
    setsWrap.appendChild(setsLab);
    setsWrap.appendChild(setsSel);

    // Reps
    const repsWrap = document.createElement("div");
    const repsLab = document.createElement("label");
    repsLab.textContent = "Reps";
    const repsSel = document.createElement("select");
    repsSel.className = "repsSel";
    fillSelect(repsSel, repOptions, "");
    repsWrap.appendChild(repsLab);
    repsWrap.appendChild(repsSel);

    // Rest
    const restWrap = document.createElement("div");
    const restLab = document.createElement("label");
    restLab.textContent = "Rest";
    const restSel = document.createElement("select");
    restSel.className = "restSel";
    // show as seconds in value, pretty label in text
    restSel.innerHTML = "";
    restOptions.forEach(v => restSel.appendChild(makeOption(v, fmtRest(v))));
    restWrap.appendChild(restLab);
    restWrap.appendChild(restSel);

    // Remove
    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.className = "btn btnDanger removeBtn";
    removeBtn.textContent = "Remove";
    removeBtn.addEventListener("click", () => {
      row.remove();
      updateCounts();
    });

    // Append in correct order:
    if (kind === "primary"){
      row.appendChild(exWrap);
      row.appendChild(setsWrap);
      row.appendChild(repsWrap);
      row.appendChild(wtWrap);
      row.appendChild(restWrap);
      row.appendChild(removeBtn);
      row.appendChild(detailsWrap);
    } else {
      row.appendChild(exWrap);
      row.appendChild(setsWrap);
      row.appendChild(repsWrap);
      row.appendChild(wtWrap);
      row.appendChild(restWrap);
      row.appendChild(removeBtn);
      row.appendChild(detailsWrap);
    }

    // Populate exercise list based on kind
    const getExerciseList = () => {
      if (kind === "primary"){
        const pg = $("primaryGroup").value;
        return primaryGroups[pg] ?? [];
      } else {
        const g = groupSel ? groupSel.value : Object.keys(auxGroups)[0];
        return auxGroups[g] ?? [];
      }
    };

    const refreshExercises = () => {
      const list = getExerciseList();
      // Apply favorites ordering / filtering
      const user = getActiveUser();
      if (kind === "primary"){
        const favArr = (getUserFavs(user).primary[$("primaryGroup").value] || []);
        fillDataList(exList, sortWithFavs(list, favArr));
      } else {
        const g = groupSel ? groupSel.value : "";
        const favArr = (getUserFavs(user).aux[g] || []);
        fillDataList(exList, sortWithFavs(list, favArr));
      }

      // Preserve existing typed value if it matches; otherwise apply preset/default
      if (exerciseValue && list.includes(exerciseValue)) exInput.value = exerciseValue;
      else if (exInput.value && list.includes(exInput.value)) { /* keep */ }
      else exInput.value = "";
    };

    refreshExercises();

    // Favorite button behavior
    const updateFavBtnLabel = () => {
      const user = getActiveUser();
      const ex = (exInput.value || "").trim();
      if (!ex){ favBtn.textContent = "‚òÜ Favorite"; return; }
      if (kind === "primary"){
        const g = $("primaryGroup").value;
        favBtn.textContent = isFavPrimary(user, g, ex) ? "‚òÖ Favorited" : "‚òÜ Favorite";
      } else {
        const g = groupSel ? groupSel.value : "";
        favBtn.textContent = isFavAux(user, g, ex) ? "‚òÖ Favorited" : "‚òÜ Favorite";
      }
    };

    favBtn.addEventListener("click", () => {
      const user = getActiveUser();
      const ex = (exInput.value || "").trim();
      if (!ex){ toast("Pick an exercise first"); return; }
      if (kind === "primary"){
        const g = $("primaryGroup").value;
        toggleFavPrimary(user, g, ex);
      } else {
        const g = groupSel ? groupSel.value : "";
        toggleFavAux(user, g, ex);
      }
      updateFavBtnLabel();
      refreshExercises();
      toast("Updated favorites");
    });

    exInput.addEventListener("change", updateFavBtnLabel);
    exInput.addEventListener("keyup", updateFavBtnLabel);
    if (groupSel) groupSel.addEventListener("change", updateFavBtnLabel);
    updateFavBtnLabel();

    // For aux: changing group updates exercises
    if (groupSel){
      groupSel.addEventListener("change", () => {
        exerciseValue = ""; // reset
        refreshExercises();
      });
    }

    // Defaults (manual add)
    if (setsValue) setsSel.value = String(setsValue);
    else setsSel.value = (kind === "primary") ? "3" : "3";

    if (repsValue) repsSel.value = String(repsValue);
    else repsSel.value = (kind === "primary") ? "10" : "12";

    if (restValue) restSel.value = String(restValue);
    else restSel.value = (kind === "primary") ? "150" : "90";

    if (typeof weightValue !== 'undefined' && weightValue !== null && weightValue !== '') wtInp.value = String(weightValue);


    return row;
  }

  function addPrimaryRow(preset={}){
    const c = $("primaryContainer");
    const row = createExerciseRow({kind:"primary", ...preset});
    c.appendChild(row);
    updateCounts();
  }

  function addAuxRow(preset={}){
    const c = $("auxContainer");
    const row = createExerciseRow({kind:"aux", ...preset});
    c.appendChild(row);
    updateCounts();
  }

  function updateCounts(){
    $("primaryCountPill").textContent = `Primary: ${$("primaryContainer").children.length}`;
    $("auxCountPill").textContent = `Aux: ${$("auxContainer").children.length}`;
  }

  // ----------------------------
  // Auto template behavior
  // ----------------------------
  function applyTemplate(mode){
    if (mode === "manual") return;

    const plan = templates[mode];
    if (!plan) return;

    // Clear existing
    $("primaryContainer").innerHTML = "";
    $("auxContainer").innerHTML = "";

    const primaryGroup = $("primaryGroup").value;
    const primaryList = primaryGroups[primaryGroup] ?? [];

    // Simple deterministic pick helper (no randomness, stable results)
    const pickN = (arr, n, start=0) => {
      const out = [];
      if (!arr.length) return out;
      for (let i=0; i<n; i++){
        out.push(arr[(start + i) % arr.length]);
      }
      return out;
    };

    // Suggested auxiliary group stacks by primary group
    const auxPlanByPrimary = {
      "Chest": ["Triceps", "Shoulders", "Abs", "Rear Delts", "Forearms"],
      "Back": ["Biceps", "Rear Delts", "Abs", "Upper Back / Traps", "Forearms"],
      "Legs": ["Quads", "Hamstrings", "Calves", "Abs", "Forearms"],
      "Shoulders": ["Rear Delts", "Triceps", "Abs", "Upper Back / Traps", "Biceps"],
      "Arms": ["Biceps", "Triceps", "Forearms", "Abs", "Rear Delts"]
    };

    const auxGroupsOrder = auxPlanByPrimary[primaryGroup] || Object.keys(auxGroups);

    // Primary rows: pick the first N exercises for the selected group
    const primChoices = pickN(primaryList, plan.pCount, 0);
    for (let i=0; i<plan.pCount; i++){
      addPrimaryRow({
        setsValue: plan.pSets,
        repsValue: plan.pReps,
        restValue: plan.pRest,
        exerciseValue: primChoices[i] || ""
      });
    }

    // Aux rows: cycle through recommended aux groups and pick first exercise from each group
    for (let i=0; i<plan.aCount; i++){
      const g = auxGroupsOrder[i % auxGroupsOrder.length];
      const exList = auxGroups[g] ?? [];
      const ex = exList.length ? exList[i % exList.length] : "";
      addAuxRow({
        groupValue: g,
        exerciseValue: ex,
        setsValue: plan.aSets,
        repsValue: plan.aReps,
        restValue: plan.aRest
      });
    }

    toast(`Auto-filled: ${mode}`);
  }

  // ----------------------------
  // Serialization
  // ----------------------------
  function readRows(containerEl, kind){
    const rows = Array.from(containerEl.children);
    return rows.map(row => {
      const obj = {
        kind,
        exercise: (row.querySelector(".exerciseInput")?.value || "").trim(),
        sets: row.querySelector(".setsSel")?.value || "",
        reps: row.querySelector(".repsSel")?.value || "",
        restSec: row.querySelector(".restSel")?.value || "",
        weight: row.querySelector(".weightInp")?.value || "",
        setDetails: Array.from(row.querySelectorAll(".setWeightInp")).map(wi => {
          const s = wi.getAttribute("data-set");
          const ri = row.querySelector(`.setRepsInp[data-set="${s}"]`);
          return { set: parseInt(s,10), weight: wi.value || "", reps: (ri ? (ri.value||"") : "") };
        }).filter(x => (x.weight || x.reps))

      };
      if (kind === "aux"){
        obj.group = row.querySelector(".auxGroupSel")?.value || "";
      }


  // ----------------------------
  // Share via link (no backend)
  // ----------------------------
  function base64UrlEncode(str){
    const b64 = btoa(unescape(encodeURIComponent(str)));
    return b64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
  }

  function base64UrlDecode(b64url){
    let b64 = b64url.replace(/-/g, "+").replace(/_/g, "/");
    while (b64.length % 4) b64 += "=";
    const str = decodeURIComponent(escape(atob(b64)));
    return str;
  }

  function getCurrentWorkoutDraft(){
    const date = $("workoutDate").value || "";
    const primary = readRows($("primaryContainer"), "primary");
    const aux = readRows($("auxContainer"), "aux");
    const draft = {
      date,
      userName: ($("userName").value || "").trim() || "Default",      primaryGroup: $("primaryGroup").value,
      intensity: $("intensity").value,
      intensityLabel: {
        manual:"Manual",
        light:"Light",
        moderate:"Moderate",
        intense:"Intense"
      }[$("intensity").value] || "Manual",
      notes: ($("notes").value || "").trim(),
      primary,
      aux
    };
    return draft;
  }

  function openShareModal(link){
    $("shareLink").value = link;
    $("shareModal").style.display = "block";
  }

  function closeShareModal(){
    $("shareModal").style.display = "none";
  }

  $("shareBtn").addEventListener("click", () => {
    const draft = getCurrentWorkoutDraft();
    if (!draft.primary.length){
      toast("Add at least 1 primary exercise");
      return;
    }
    const payload = base64UrlEncode(JSON.stringify(draft));
    const link = `${location.origin}${location.pathname}#w=${payload}`;
    openShareModal(link);
    toast("Share link ready");
  });

  $("closeShareBtn").addEventListener("click", () => closeShareModal());

  $("copyShareBtn").addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText($("shareLink").value || "");
      toast("Copied");
    }catch(e){
      toast("Copy blocked (browser permission)");
    }
  });

  $("shareModal").addEventListener("click", (e) => {
    if (e.target === $("shareModal")) closeShareModal();
  });

  function importSharedWorkoutFromHash(){
    const h = location.hash || "";
    if (!h.startsWith("#w=")) return;
    const token = h.slice(3);
    try{
      const json = base64UrlDecode(token);
      const draft = JSON.parse(json);

      if (draft.date) $("workoutDate").value = draft.date;
      if (draft.userName) $("userName").value = draft.userName;      if (draft.primaryGroup) $("primaryGroup").value = draft.primaryGroup;
      $("intensity").value = "manual";
      $("notes").value = draft.notes || "";

      $("primaryContainer").innerHTML = "";
      $("auxContainer").innerHTML = "";

      (draft.primary || []).forEach(x => addPrimaryRow({
        exerciseValue: x.exercise,
        setsValue: x.sets,
        repsValue: x.reps,
        restValue: x.restSec,
        weightValue: x.weight
      }));

      (draft.aux || []).forEach(x => addAuxRow({
        groupValue: x.group,
        exerciseValue: x.exercise,
        setsValue: x.sets,
        repsValue: x.reps,
        restValue: x.restSec,
        weightValue: x.weight
      }));

      updateCounts();
      history.replaceState(null, document.title, location.pathname + location.search);
      toast("Shared workout loaded");
    }catch(e){
      toast("Bad share link");
    }
  }
      return obj;
    }).filter(x => x.exercise);
  }

  const STORAGE_KEY = "workout_log_v2"; // bumped due to schema change (restSec)

  function loadLog(){
    try{
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    }catch(e){
      return [];
    }
  }

  function saveLog(items){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
  }

  function workoutSummary(item){
    const p = item.primary.map(x => `${x.exercise}${x.weight ? " @ " + x.weight + "lb" : ""} (${x.sets}√ó${x.reps}, rest ${fmtRest(x.restSec)})`);
    const a = item.aux.map(x => `${x.group}: ${x.exercise}${x.weight ? " @ " + x.weight + "lb" : ""} (${x.sets}√ó${x.reps}, rest ${fmtRest(x.restSec)})`);
    return {p, a};
  }

  // ----------------------------
  // Log UI
  // ----------------------------
  
  function startOfWeekISO(d){
    // Monday start
    const x = new Date(d);
    const day = (x.getDay() + 6) % 7; // Mon=0
    x.setHours(0,0,0,0);
    x.setDate(x.getDate() - day);
    return x;
  }

  function parseDateYMD(ymd){
    const [y,m,dd] = String(ymd||"").split("-").map(v=>parseInt(v,10));
    if (!y || !m || !dd) return null;
    const d = new Date(y, m-1, dd);
    d.setHours(0,0,0,0);
    return d;
  }

  function computeUserDashboard(user){
    const items = loadLog().filter(x => ((x.userName||"Default").trim()||"Default") === user);
    const now = new Date();
    const sow = startOfWeekISO(now).getTime();
    const thisWeek = items.filter(x => {
      const d = parseDateYMD(x.date);
      return d && d.getTime() >= sow;
    });

    // sessions this week
    const sessions = thisWeek.length;

    // sets by primaryGroup this week
    const setsByGroup = {};
    thisWeek.forEach(w => {
      const g = w.primaryGroup || "Unknown";
      const totalSets = (w.primary||[]).reduce((a,r)=>a + (parseInt(r.sets||"0",10)||0),0)
                      + (w.aux||[]).reduce((a,r)=>a + (parseInt(r.sets||"0",10)||0),0);
      setsByGroup[g] = (setsByGroup[g] || 0) + totalSets;
    });

    // streak: consecutive days with at least one session
    const days = Array.from(new Set(items.map(x => x.date).filter(Boolean))).sort();
    let streak = 0;
    if (days.length){
      // walk backwards from today
      let cur = new Date(); cur.setHours(0,0,0,0);
      const set = new Set(days);
      while (set.has(cur.toISOString().slice(0,10))){
        streak += 1;
        cur.setDate(cur.getDate() - 1);
      }
    }

    return {sessions, setsByGroup, streak};
  }

  function renderDashboard(){
    const user = ($("logUserFilter") && $("logUserFilter").value !== "__all__") ? $("logUserFilter").value : getActiveUser();
    const d = computeUserDashboard(user);
    const ul = $("dashList");
    const meta = $("dashMeta");
    if (!ul || !meta) return;

    meta.textContent = `${user} ‚Ä¢ This week`;
    ul.innerHTML = "";

    const li1 = document.createElement("li");
    li1.textContent = `Sessions this week: ${d.sessions}`;
    ul.appendChild(li1);

    const li2 = document.createElement("li");
    li2.textContent = `Current streak: ${d.streak} day(s)`;
    ul.appendChild(li2);

    const groups = Object.keys(d.setsByGroup).sort((a,b)=>d.setsByGroup[b]-d.setsByGroup[a]);
    if (groups.length){
      const li3 = document.createElement("li");
      li3.textContent = `Sets by focus (this week): ` + groups.slice(0,4).map(g=>`${g} ${d.setsByGroup[g]}`).join(" ‚Ä¢ ");
      ul.appendChild(li3);
    }
  }

function renderLog(){
    const list = $("logList");
    const items = loadLog();

    // Populate user filter options from items
    const filterSel = $("logUserFilter");
    const currentFilter = filterSel ? filterSel.value : "__all__";
    if (filterSel){
      const users = Array.from(new Set(items.map(x => (x.userName || "Default").trim() || "Default"))).sort((a,b)=>a.localeCompare(b));
      filterSel.innerHTML = "";
      filterSel.appendChild(makeOption("__all__", "All users"));
      users.forEach(u => filterSel.appendChild(makeOption(u, u)));
      // Keep selection if possible
      const keep = users.includes(currentFilter) ? currentFilter : "__all__";
      filterSel.value = keep;
    }

    const activeUser = (filterSel && filterSel.value !== "__all__") ? filterSel.value : "__all__";
    const shownItems = (activeUser === "__all__") ? items : items.filter(x => ((x.userName||"Default").trim()||"Default") === activeUser);
if (!shownItems.length){
      list.innerHTML = `<div class="empty">No saved workouts yet. Build one on the left, then hit <b>Save to log</b>.</div>`;
      return;
    }

    list.innerHTML = "";
    shownItems.slice().reverse().forEach((item, idxFromEnd) => {
      const idx = items.length - 1 - idxFromEnd; // real index

      const div = document.createElement("div");
      div.className = "logItem";

      const top = document.createElement("div");
      top.className = "top";

      const left = document.createElement("div");
      const h3 = document.createElement("h3");
      h3.textContent = `${item.date} ‚Äî ${item.primaryGroup}`;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `${item.userName || "Default"} ‚Ä¢ ${item.intensityLabel}${item.prUpdates && item.prUpdates.length ? " ‚Ä¢ PR: " + item.prUpdates.slice(0,2).join(", ") : ""}${item.notes ? " ‚Ä¢ Notes included" : ""}`;

      left.appendChild(h3);
      left.appendChild(meta);

      const actions = document.createElement("div");
      actions.style.display = "flex";
      actions.style.gap = "8px";
      actions.style.flexWrap = "wrap";
      actions.style.justifyContent = "flex-end";

      const loadBtn = document.createElement("button");
      loadBtn.type = "button";
      loadBtn.className = "btn";
      loadBtn.textContent = "Load";
      loadBtn.addEventListener("click", () => {
        loadWorkoutToForm(item);
        toast("Loaded workout");
      });

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "btn btnDanger";
      delBtn.textContent = "Delete";
      delBtn.addEventListener("click", () => {
        const items2 = loadLog();
        const delId = item.id;
        const newItems = items2.filter(x => x.id !== delId);
        saveLog(newItems);
        renderLog();
        toast("Deleted");
        return;
        saveLog(items2);
        renderLog();
        toast("Deleted");
      });

      actions.appendChild(loadBtn);
      actions.appendChild(delBtn);

      top.appendChild(left);
      top.appendChild(actions);

      const {p, a} = workoutSummary(item);

      const ul = document.createElement("ul");
      p.forEach(line => {
        const li = document.createElement("li");
        li.textContent = `Primary: ${line}`;
        ul.appendChild(li);
      });
      a.forEach(line => {
        const li = document.createElement("li");
        li.textContent = `Aux: ${line}`;
        ul.appendChild(li);
      });

      if (item.notes){
        const li = document.createElement("li");
        li.textContent = `Notes: ${item.notes}`;
        ul.appendChild(li);
      }

      div.appendChild(top);
      div.appendChild(ul);

      list.appendChild(div);
    });
    renderDashboard();
  }

  function loadWorkoutToForm(item){
    $("workoutDate").value = item.date;
    $("intensity").value = "manual";
    $("primaryGroup").value = item.primaryGroup;
    $("notes").value = item.notes || "";
    $("userName").value = item.userName || "Default";
    $("primaryContainer").innerHTML = "";
    $("auxContainer").innerHTML = "";

    item.primary.forEach(x => addPrimaryRow({
      exerciseValue: x.exercise,
      setsValue: x.sets,
      repsValue: x.reps,
      restValue: x.restSec,
      weightValue: x.weight
    }));

    // Restore per-set details if present
    try{
      const row = $("primaryContainer").lastElementChild;
      if (row && Array.isArray(x.setDetails) && x.setDetails.length){
        const details = row.querySelector('.setDetailsWrap');
        const toggle = row.querySelector('button.btn');
        // open details
        if (details) details.style.display = 'block';
        // trigger rebuild
        const setsSel = row.querySelector('.setsSel');
        if (setsSel){
          const evt = new Event('change');
          setsSel.dispatchEvent(evt);
        }
        x.setDetails.forEach(s => {
          const wi = row.querySelector(`.setWeightInp[data-set="${s.set}"]`);
          const ri = row.querySelector(`.setRepsInp[data-set="${s.set}"]`);
          if (wi) wi.value = s.weight || '';
          if (ri) ri.value = s.reps || '';
        });
      }
    }catch(e){}


    item.aux.forEach(x => addAuxRow({
      groupValue: x.group,
      exerciseValue: x.exercise,
      setsValue: x.sets,
      repsValue: x.reps,
      restValue: x.restSec,
      weightValue: x.weight
    }));

    // Restore per-set details if present
    try{
      const row = $("auxContainer").lastElementChild;
      if (row && Array.isArray(x.setDetails) && x.setDetails.length){
        const details = row.querySelector('.setDetailsWrap');
        if (details) details.style.display = 'block';
        const setsSel = row.querySelector('.setsSel');
        if (setsSel){
          const evt = new Event('change');
          setsSel.dispatchEvent(evt);
        }
        x.setDetails.forEach(s => {
          const wi = row.querySelector(`.setWeightInp[data-set="${s.set}"]`);
          const ri = row.querySelector(`.setRepsInp[data-set="${s.set}"]`);
          if (wi) wi.value = s.weight || '';
          if (ri) ri.value = s.reps || '';
        });
      }
    }catch(e){}


    updateCounts();
  }

  // ----------------------------
  // Events
  // ----------------------------
  $("addPrimaryBtn").addEventListener("click", () => addPrimaryRow());
  $("addAuxBtn").addEventListener("click", () => addAuxRow());

  $("primaryGroup").addEventListener("change", () => {
    // When primary group changes, refresh all primary exercise datalists
    Array.from($("primaryContainer").children).forEach(row => {
      const exInput = row.querySelector(".exerciseInput");
      const exList = row.querySelector("datalist");
      if (!exInput || !exList) return;

      const list = primaryGroups[$("primaryGroup").value] ?? [];
      // Apply favorites ordering / filtering
      const user = getActiveUser();
      if (kind === "primary"){
        const favArr = (getUserFavs(user).primary[$("primaryGroup").value] || []);
        fillDataList(exList, sortWithFavs(list, favArr));
      } else {
        const g = groupSel ? groupSel.value : "";
        const favArr = (getUserFavs(user).aux[g] || []);
        fillDataList(exList, sortWithFavs(list, favArr));
      }

      // If current value no longer matches, clear it so user re-selects
      if (exInput.value && !list.includes(exInput.value)) exInput.value = "";
    });
  
    // Rotation memory tip (based on recent history)
    try{
      const user = getActiveUser();
      const g = $("primaryGroup").value;
      const recent = loadLog().filter(x => ((x.userName||"Default").trim()||"Default")===user && x.primaryGroup===g).slice(-3);
      const firsts = recent.map(w => ((w.primary||[])[0]||{}).exercise).filter(Boolean);
      if (firsts.length === 3 && firsts.every(x => x === firsts[0])){
        toast("Rotation tip: consider swapping your main lift");
      }
    }catch(e){}
  });

  $("intensity").addEventListener("change", (e) => {
    applyTemplate(e.target.value);
    updateCounts();
  });

  $("resetBtn").addEventListener("click", () => {
    $("intensity").value = "manual";
    $("notes").value = "";
    $("primaryContainer").innerHTML = "";
    $("auxContainer").innerHTML = "";
    if ($("primaryContainer").children.length === 0) addPrimaryRow();
    updateCounts();
    toast("Reset");
  });

  $("saveBtn").addEventListener("click", () => {
    const date = $("workoutDate").value;
    if (!date){
      toast("Pick a date first");
      return;
    }

    const primary = readRows($("primaryContainer"), "primary");
    if (!primary.length){
      toast("Add at least 1 primary exercise");
      return;
    }
    const aux = readRows($("auxContainer"), "aux");

    const intensityVal = $("intensity").value;
    const intensityLabel = {
      manual:"Manual",
      light:"Light",
      moderate:"Moderate",
      intense:"Intense"
    }[intensityVal] || "Manual";

    const item = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2),
      date,
      primaryGroup: $("primaryGroup").value,
      intensity: intensityVal,
      intensityLabel,
      notes: ($("notes").value || "").trim(),
      userName: ($("userName").value || "").trim() || "Default",      primary,
      aux,
      createdAt: new Date().toISOString()
    };

    const prUpdates = updatePRsFromWorkout(item);
    item.prUpdates = prUpdates;

    const items = loadLog();
    items.push(item);
    try{ localStorage.setItem(USER_DEFAULT_KEY, item.userName); }catch(e){ /* ignore */ }
    saveLog(items);
    renderLog();
    toast("Saved to log");
    // Progressive overload suggestion (simple)
    try{
      const user = item.userName;
      const prev = loadLog().filter(x => x.userName === user).slice(-2, -1)[0];
      if (prev){
        const suggestions = [];
        const prevMap = new Map((prev.primary||[]).concat(prev.aux||[]).map(r => [r.exercise, r]));
        (item.primary||[]).concat(item.aux||[]).forEach(r => {
          const p = prevMap.get(r.exercise);
          const w = parseFloat(r.weight||"0");
          const pr = parseInt(r.reps||"0",10)||0;
          if (w && pr){
            if (p && parseFloat(p.weight||"0") === w && pr >= (parseInt(p.reps||"0",10)||0)){
              suggestions.push(`${r.exercise}: try +5 lb next time`);
            }
          }
        });
        if (suggestions.length){
          toast("Progression tip available");
          // store in notes box for visibility
          const n = $("notes");
          if (n && !n.value.includes("Progression tip")){
            n.value = (n.value ? n.value + "\n\n" : "") + "Progression tip:\n- " + suggestions.slice(0,3).join("\n- ");
          }
        }
      }
    }catch(e){ /* ignore */ }

  });

  $("clearBtn").addEventListener("click", () => {
    if (!confirm("Clear ALL saved workouts from this browser?")) return;
    localStorage.removeItem(STORAGE_KEY);
    renderLog();
    toast("Cleared");
  });

  $("exportBtn").addEventListener("click", () => {
    const items = loadLog();
    $("exportText").value = JSON.stringify(items, null, 2);
    $("exportBox").style.display = "block";
    toast("Export ready");
  });

  $("hideExportBtn").addEventListener("click", () => {
    $("exportBox").style.display = "none";
  });

  $("copyExportBtn").addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText($("exportText").value || "");
      toast("Copied");
    }catch(e){
      toast("Copy blocked (browser permission)");
    }
  });
  // User filter events
  $("logUserFilter").addEventListener("change", () => {
    renderLog();
    toast("Filtered");
  });

  $("clearUserFilterBtn").addEventListener("click", () => {
    $("logUserFilter").value = "__all__";
    renderLog();
    toast("All users");
  });

  // ----------------------------
  // Template editor UI
  // ----------------------------
  function renderTemplatesEditor(){
    const host = $("templatesEditor");
    if (!host) return;

    const cardFor = (key, label) => {
      const t = templates[key];

      const wrap = document.createElement("div");
      wrap.className = "logItem";
      wrap.style.marginBottom = "12px";

      const head = document.createElement("div");
      head.className = "top";

      const left = document.createElement("div");
      const h3 = document.createElement("h3");
      h3.textContent = label;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `Primary ${t.pCount} ‚Ä¢ Aux ${t.aCount} ‚Ä¢ P ${t.pSets}√ó${t.pReps} @ ${fmtRest(t.pRest)} ‚Ä¢ A ${t.aSets}√ó${t.aReps} @ ${fmtRest(t.aRest)}`;
      left.appendChild(h3);
      left.appendChild(meta);

      head.appendChild(left);
      wrap.appendChild(head);

      const grid = document.createElement("div");
      grid.className = "grid2";
      grid.style.marginTop = "12px";

      const field = (id, lab, val, min, max, hint) => {
        const d = document.createElement("div");
        const l = document.createElement("label");
        l.setAttribute("for", id);
        l.textContent = lab;
        const inp = document.createElement("input");
        inp.type = "number";
        inp.id = id;
        inp.min = String(min);
        inp.max = String(max);
        inp.step = "1";
        inp.value = String(val);
        inp.style.width = "100%";
        inp.style.background = "rgba(0,0,0,.24)";
        inp.style.color = "var(--text)";
        inp.style.border = "1px solid rgba(255,255,255,.12)";
        inp.style.padding = "10px 11px";
        inp.style.borderRadius = "14px";
        if (hint){
          const p = document.createElement("div");
          p.className = "hint";
          p.style.marginTop = "6px";
          p.textContent = hint;
          d.appendChild(l);
          d.appendChild(inp);
          d.appendChild(p);
        }else{
          d.appendChild(l);
          d.appendChild(inp);
        }
        return d;
      };

      grid.appendChild(field(`${key}_pCount`, "Primary exercises (count)", t.pCount, 1, 6, ""));
      grid.appendChild(field(`${key}_aCount`, "Aux exercises (count)", t.aCount, 0, 8, ""));
      grid.appendChild(field(`${key}_pSets`, "Primary sets", t.pSets, 1, 6, ""));
      grid.appendChild(field(`${key}_pReps`, "Primary reps", t.pReps, 1, 30, ""));
      grid.appendChild(field(`${key}_pRest`, "Primary rest (sec)", t.pRest, 15, 600, "Common: 90‚Äì180 sec"));
      grid.appendChild(field(`${key}_aSets`, "Aux sets", t.aSets, 1, 6, ""));
      grid.appendChild(field(`${key}_aReps`, "Aux reps", t.aReps, 1, 30, ""));
      grid.appendChild(field(`${key}_aRest`, "Aux rest (sec)", t.aRest, 15, 600, "Common: 45‚Äì120 sec"));

      wrap.appendChild(grid);
      return wrap;
    };

    host.innerHTML = "";
    host.appendChild(cardFor("light", "Light"));
    host.appendChild(cardFor("moderate", "Moderate"));
    host.appendChild(cardFor("intense", "Intense"));
  }

  function openTemplatesModal(){
    renderTemplatesEditor();
    $("templatesModal").style.display = "block";
  }

  function closeTemplatesModal(){
    $("templatesModal").style.display = "none";
  }

  function readTemplatesFromEditor(){
    const readOne = (key) => ({
      pCount: clampInt($(key+"_pCount").value, 1, 6, templates[key].pCount),
      aCount: clampInt($(key+"_aCount").value, 0, 8, templates[key].aCount),
      pSets:  clampInt($(key+"_pSets").value, 1, 6, templates[key].pSets),
      pReps:  clampInt($(key+"_pReps").value, 1, 30, templates[key].pReps),
      pRest:  clampInt($(key+"_pRest").value, 15, 600, templates[key].pRest),
      aSets:  clampInt($(key+"_aSets").value, 1, 6, templates[key].aSets),
      aReps:  clampInt($(key+"_aReps").value, 1, 30, templates[key].aReps),
      aRest:  clampInt($(key+"_aRest").value, 15, 600, templates[key].aRest)
    });

    return {
      light: readOne("light"),
      moderate: readOne("moderate"),
      intense: readOne("intense")
    };
  }

  $("editTemplatesBtn").addEventListener("click", () => {
    openTemplatesModal();
    toast("Edit templates");
  });

  $("closeTemplatesBtn").addEventListener("click", () => closeTemplatesModal());

  $("saveTemplatesBtn").addEventListener("click", () => {
    const next = readTemplatesFromEditor();
    templates = next;
    saveTemplates(next);
    closeTemplatesModal();
    toast("Templates saved");
  });

  $("resetTemplatesBtn").addEventListener("click", () => {
    templates = sClone(DEFAULT_TEMPLATES);
    saveTemplates(templates);
    toast("Templates reset");
  });

  $("addTemplateNoteBtn").addEventListener("click", () => {
    const n = $("templateNote");
    n.style.display = (n.style.display === "none") ? "block" : "none";
  });

  // Close modal on background click
  $("templatesModal").addEventListener("click", (e) => {
    if (e.target === $("templatesModal")) closeTemplatesModal();
  });

  $("toggleFavsBtn").addEventListener("click", () => {
    showFavsOnly = !showFavsOnly;
    $("toggleFavsBtn").textContent = showFavsOnly ? "‚≠ê Favorites (only)" : "‚≠ê Favorites";

    // Refresh all existing row datalists to reflect filtering/order
    Array.from($("primaryContainer").children).forEach(row => {
      const dl = row.querySelector("datalist");
      if (!dl) return;
      const list = primaryGroups[$("primaryGroup").value] ?? [];
      const favArr = (getUserFavs(getActiveUser()).primary[$("primaryGroup").value] || []);
      fillDataList(dl, sortWithFavs(list, favArr));
    });

    Array.from($("auxContainer").children).forEach(row => {
      const dl = row.querySelector("datalist");
      const gSel = row.querySelector(".auxGroupSel");
      if (!dl || !gSel) return;
      const list = auxGroups[gSel.value] ?? [];
      const favArr = (getUserFavs(getActiveUser()).aux[gSel.value] || []);
      fillDataList(dl, sortWithFavs(list, favArr));
    });

    toast(showFavsOnly ? "Favorites only" : "Favorites + all");
  });

  // ----------------------------
  // Profile + Performance Mode
  // ----------------------------
  function openProfile(){
    const user = getActiveUser();
    const s = getUserSettings(user);
    $("profileGoal").value = s.goal || "Hypertrophy";
    $("profileEquipment").value = s.equipment || "Full gym";
    $("profileRepLow").value = s.prefRepLow ?? 6;
    $("profileRepHigh").value = s.prefRepHigh ?? 12;
    $("profileModal").style.display = "block";
  }
  function closeProfile(){ $("profileModal").style.display = "none"; }

  $("profileBtn").addEventListener("click", () => { openProfile(); toast("Profile"); });
  $("closeProfileBtn").addEventListener("click", () => closeProfile());
  $("saveProfileBtn").addEventListener("click", () => {
    const user = getActiveUser();
    const next = {
      goal: $("profileGoal").value,
      equipment: $("profileEquipment").value,
      prefRepLow: clampInt($("profileRepLow").value, 1, 30, 6),
      prefRepHigh: clampInt($("profileRepHigh").value, 1, 30, 12)
    };
    if (next.prefRepHigh < next.prefRepLow) next.prefRepHigh = next.prefRepLow;
    setUserSettings(user, next);
    closeProfile();
    toast("Profile saved");
  });
  $("profileModal").addEventListener("click", (e) => { if (e.target === $("profileModal")) closeProfile(); });

  function setPerfMode(on){
    document.body.classList.toggle("perf", !!on);
    const ui = loadObj(UI_KEY, {});
    ui.perf = !!on;
    saveObj(UI_KEY, ui);
  }

  $("perfModeBtn").addEventListener("click", () => {
    const on = !document.body.classList.contains("perf");
    setPerfMode(on);
    toast(on ? "Performance mode" : "Normal mode");
  });


  // ----------------------------
  // Init
  // ----------------------------
  initGroupSelects();

  // Set date default to today (local)
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,"0");
  const dd = String(today.getDate()).padStart(2,"0");
  $("workoutDate").value = `${yyyy}-${mm}-${dd}`;

  // Default user name (remember last used)
  try{
    const u = localStorage.getItem(USER_DEFAULT_KEY);
    if (u) $("userName").value = u;
    else $("userName").value = "Default";
  }catch(e){ $("userName").value = "Default"; }
  
  // Import shared workout if link contains one
  importSharedWorkoutFromHash();

  // Start with one primary row
  if ($("primaryContainer").children.length === 0) addPrimaryRow();
  updateCounts();
  renderLog();

})();
</script>

  <div id="revFooter" style="position:fixed;left:12px;bottom:10px;z-index:50;font-size:11px;opacity:.55;">
    Rev v15 ‚Ä¢ Build 2026-02-24 02:27:40
  </div>

</body>
</html>
